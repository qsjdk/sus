#include <ros/ros.h>
#include <image_transport/image_transport.h>
#include <cv_bridge/cv_bridge.h>
#include <sensor_msgs/Image.h>
#include <sensor_msgs/image_encodings.h>

#include <opencv2/opencv.hpp>
#include <opencv2/aruco.hpp>

// ------------------ 全局变量 ------------------

// ArUco 字典和参数
cv::Ptr<cv::aruco::Dictionary> g_dictionary;
cv::Ptr<cv::aruco::DetectorParameters> g_parameters;

// 相机内参和畸变
cv::Mat g_cameraMatrix;
cv::Mat g_distCoeffs;

// 你的 ArUco 检测回调
void imageCallback(const sensor_msgs::ImageConstPtr& msg)
{
    // 1. ROS 图像 -> cv::Mat
    cv_bridge::CvImagePtr cv_ptr;
    try {
        cv_ptr = cv_bridge::toCvCopy(msg, sensor_msgs::image_encodings::BGR8);
    } catch (cv_bridge::Exception& e) {
        ROS_ERROR("cv_bridge exception: %s", e.what());
        return;
    }
    cv::Mat frame = cv_ptr->image;

    if (frame.empty()) {
        ROS_WARN("Empty frame");
        return;
    }

    // 2. 转灰度
    cv::Mat gray;
    cv::cvtColor(frame, gray, cv::COLOR_BGR2GRAY);

    // 3. ArUco 检测
    std::vector<int> ids;
    std::vector<std::vector<cv::Point2f>> corners;
    cv::aruco::detectMarkers(gray, g_dictionary, corners, ids, g_parameters);

    if (!ids.empty()) {
        cv::aruco::drawDetectedMarkers(frame, corners, ids);

        // 4. 姿态估计（markerLength 单位：米，自己根据实际打印尺寸改）
        float markerLength = 0.05f; // 比如 5cm
        std::vector<cv::Vec3d> rvecs, tvecs;
        cv::aruco::estimatePoseSingleMarkers(
            corners, markerLength, g_cameraMatrix, g_distCoeffs, rvecs, tvecs);

        for (size_t i = 0; i < ids.size(); ++i) {
            // 画坐标轴
            cv::aruco::drawAxis(frame, g_cameraMatrix, g_distCoeffs,
                                rvecs[i], tvecs[i], markerLength * 0.5f);

            // 打印位姿
            ROS_INFO("Marker ID: %d", ids[i]);
            ROS_INFO("  tvec (x,y,z): %.4f, %.4f, %.4f",
                     tvecs[i][0], tvecs[i][1], tvecs[i][2]);
            ROS_INFO("  rvec (rx,ry,rz): %.4f, %.4f, %.4f",
                     rvecs[i][0], rvecs[i][1], rvecs[i][2]);
        }
    }

    // 5. 显示画面
    cv::imshow("ZED ArUco", frame);
    cv::waitKey(1);
}

int main(int argc, char** argv)
{
    ros::init(argc, argv, "zed_aruco_detection");
    ros::NodeHandle nh;

    // ------------ 初始化 ArUco -----------
    g_dictionary = cv::aruco::getPredefinedDictionary(cv::aruco::DICT_6X6_250);
    g_parameters = cv::aruco::DetectorParameters::create();

    // ------------ 相机标定参数（用你刚才算的那组）-----------
    double fx = 260.1543273925781;
    double fy = 260.1543273925781;
    double cx = 326.7884826660156;
    double cy = 179.41473388671875;

    g_cameraMatrix = (cv::Mat_<double>(3, 3) <<
        fx, 0.0, cx,
        0.0, fy, cy,
        0.0, 0.0, 1.0);

    // ZED rectified 图像畸变为 0
    g_distCoeffs = (cv::Mat_<double>(5, 1) <<
        0.0, 0.0, 0.0, 0.0, 0.0);

    // ------------ 订阅 ZED 图像话题 -----------
    image_transport::ImageTransport it(nh);
    image_transport::Subscriber sub = it.subscribe(
        "/zed2/zed_node/left/image_rect_color", 1, imageCallback);
    // 如果你用的是别的 topic，比如 /zed2/zed_node/rgb/image_rect_color 就改这里

    ROS_INFO("ZED ArUco detection node started.");
    ros::spin();

    return 0;
}
